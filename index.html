<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR Gesture Shooter</title>
    <script src="https://cdn.jsdelivr.net/npm/three@0.152.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4.1646424915/hands.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils@0.3.1646424915/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.3.1646424915/camera_utils.js" crossorigin="anonymous"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: sans-serif; }
        #game-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; }
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #111; color: white; display: flex;
            flex-direction: column; align-items: center; justify-content: center; z-index: 100;
        }
        #ui { position: absolute; top: 20px; left: 20px; color: #0f0; z-index: 20; font-size: 28px; font-weight: bold; pointer-events: none; }
        .loader { border: 5px solid #333; border-top: 5px solid #0f0; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <div class="loader"></div>
        <div id="status">STAGE 1: Loading AI Brain...<br>Please check for a Camera Popup at the top!</div>
    </div>

    <div id="ui">SCORE: <span id="score">0</span></div>
    <video id="input-video" style="display:none" playsinline></video>
    <canvas id="game-canvas"></canvas>

<script>
/** GAME SETTINGS **/
const CONFIG = { targetCount: 4, assist: 2.5, shootDist: 0.05 };
let score = 0, isReady = false, canFire = true, targets = [], vfxs = [];

/** THREE.JS ENGINE **/
const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
const renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('game-canvas'), alpha: true, antialias: true });
renderer.setSize(window.innerWidth, window.innerHeight);

const light = new THREE.PointLight(0xffffff, 2, 100);
light.position.set(0, 10, 10);
scene.add(light);
scene.add(new THREE.AmbientLight(0xffffff, 0.5));

const laser = new THREE.Line(
    new THREE.BufferGeometry().setFromPoints([new THREE.Vector3(0,0,0), new THREE.Vector3(0,0,-10)]),
    new THREE.LineBasicMaterial({ color: 0xff0000 })
);
scene.add(laser);

/** TARGET LOGIC **/
function spawn() {
    const disc = new THREE.Mesh(
        new THREE.CylinderGeometry(0.5, 0.5, 0.1, 32),
        new THREE.MeshPhongMaterial({ color: 0xffff00 })
    );
    const a = Math.random() * 6.28;
    disc.position.set(Math.cos(a)*15, Math.sin(a)*15, -10);
    disc.rotation.x = 1.57;
    disc.userData.v = new THREE.Vector3().copy(disc.position).multiplyScalar(-0.005);
    scene.add(disc);
    targets.push(disc);
}

/** MEDIAPIPE AI **/
const video = document.getElementById('input-video');
const hands = new Hands({
    locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4.1646424915/${file}`
});

hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.7 });

hands.onResults((res) => {
    if (!isReady && res.multiHandLandmarks) {
        isReady = true;
        document.getElementById('loading-overlay').style.display = 'none';
    }
    if (res.multiHandLandmarks && res.multiHandLandmarks[0]) {
        const pts = res.multiHandLandmarks[0];
        const aim = new THREE.Vector3((0.5 - pts[8].x)*22, (0.5 - pts[8].y)*16, -10);
        
        let lock = null, dMin = CONFIG.assist;
        targets.forEach(t => { 
            let d = aim.distanceTo(t.position);
            if(d < dMin) { dMin = d; lock = t; }
        });

        let end = lock ? lock.position : aim;
        laser.material.color.setHex(lock ? 0x00ff00 : 0xff0000);
        laser.geometry.setFromPoints([new THREE.Vector3(0,-3,0), end]);

        const trigger = Math.hypot(pts[4].x - pts[5].x, pts[4].y - pts[5].y);
        if (trigger < CONFIG.shootDist && canFire) {
            shoot(lock, end);
            canFire = false;
            setTimeout(() => canFire = true, 400);
        }
    }
});

function shoot(target, pos) {
    const ctx = new AudioContext();
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.connect(g); g.connect(ctx.destination);
    o.frequency.value = target ? 600 : 200;
    g.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.1);
    o.start(); o.stop(ctx.currentTime + 0.1);

    if (target) {
        score += 10;
        document.getElementById('score').innerText = score;
        scene.remove(target);
        targets.splice(targets.indexOf(target), 1);
        spawn();
    }
}

// Start Camera
const mpCam = new window.Camera(video, {
    onFrame: async () => { await hands.send({image: video}); },
    width: 1280, height: 720
});
mpCam.start();

/** RENDER LOOP **/
function loop() {
    requestAnimationFrame(loop);
    targets.forEach(t => {
        t.position.add(t.userData.v);
        if (t.position.length() < 1) t.position.set((Math.random()-0.5)*20, (Math.random()-0.5)*20, -10);
    });
    renderer.render(scene, camera);
}
for(let i=0; i<CONFIG.targetCount; i++) spawn();
loop();
</script>
</body>
</html>
